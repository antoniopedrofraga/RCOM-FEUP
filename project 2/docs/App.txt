

Parte 1 - Aplicação para download



- Arquitetura


No segundo trabalho laboratorial de Redes de Computadores foi-nos proposto o desenvolvimento de uma aplicação para transferências de ficheiros.	Aplicação que seria baseada no Protocolo de Transferência de Arquivos (FTP ou File Transfer Protocol), protocolo esse que tem por base o Protocolo de controlo de transmissão (TCP ou Transmission Control Protocol). Neste caso é aberta uma ligação TCP para controlo e outra para transferir o ficheiro. 

A aplicação está dividida em duas partes, a primeira parte trata do processamento da string que é passada como argumento e guarda todos os seus componentes numa estrutura "url" através da função init_url. Esses componentes fazem parte da informação necessária para que a transferência ocorra, entre eles estão a string de utilizador e palavra-passe assim como a string que contém o hostname e o caminho do ficheiro a tranferir. 

** imagem com o chamamento da função init_url **

A segunda parte tem como objetivo estabelecer duas ligações (ligação A e ligação B) com o host definido anteriormente, fazendo uso de várias tarefas para o conseguir. A ligação A será a ligação de controlo, por isso é inicializada uma estrutura "connection" que guardará os dados necessários. 

** imagem com a inicialização da estrutura da ligação A **

A primeira coisa a fazer é resolver o ip a que o host está associado através da função get_ip, só assim será possível estabelecer uma ligação. Esta função contém marioritariamente código de um exemplo de obtenção de ip a partir da string de host que estava presente no moodle da displina de Redes de Computadores. Além desse código é definida a porta a usar na ligação de controlo, a porta 21. A string que contém o ip e a porta são guardados na estrutura "connection" da ligação A.

** imagem com o chamamento da função get_ip **

Depois dessas informações estarem guardadas é possível estabelecer uma ligação com o host através da função connect_to que também contém código presente no moodle de um exemplo de conexão a um determinado ip. Depois de uma tentativa de conexão com o host, no caso da ligação de controlo é recebida uma resposta com um determinado código, a função read_from_host verifica se o código recebido é o código a receber. Esta função retorna o file descriptor da ligação aberta, neste caso a ligação A.

** imagem com o chamamento da função connect_to **

Quando a ligação estiver completa é altura de o programa se autenticar fazendo uso do utilizador e palavra-passe guardados anteriormente na estrutura "url". O programa chama assim a função log_in_host, que envia uma mensagem com a informação da string de utilizador através do método send_to_host, é recebida a resposta e o código dessa mesma resposta é verificado. Repete-se o mesmo procedimento para enviar a informação sobre a string da password e no fim deve-se receber o código correspondente à resposta de um uma autenticação bem sucedida.

** imagem com o chamamento da função log_in_host **

É então enviado o comando para que o servidor de FTP transfira dados em modo passivo. É executada a função pasv_host, que envia a mensagem e interpreta a reposta do host, para que o ip e a porta a serem utilizados pela ligação B possam ser guardados. Esta resposta é interpretada pelo método get_pasv_from_host e estes dados sao guardados numa nova estrutura "connection", estrutura essa que se refere à ligação B.

** imagem com o chamamento da função pasv_host e da função get_pasv_from_host **

Já que o servidor entrou no modo passivo e existem todos os dados de ligação da conexão B (calculados e interpretados anteriormente), é executada a função connect_to, para que haja uma ligação de transferência de ficheiro. Quando a ligação estiver completa é enviado uma mensagem a partir da ligação A que define o caminho do ficheiro dentro do servidor, a resposta do servidor define se o ficheiro existe ou não. 

** imagem com o chamamento da função def_path **

Os dados para que a transferência ocorra estão enviados, então a ligação B começa a transferir o ficheiro (download_from_host), abrindo um ficheiro para escrita e escrevendo os dados recebidos a cada 1024 bytes, fechando-o quando este estiver terminado. A ligação B é fechada e passa-se à desconexão da ligação A, enviando-se uma mensagem de terminação ao servidor e libertando a memória alocada anteriormente.


- Uma transferência bem sucedida

Para uma melhor análise de resultados o grupo decidiu implementar um modo de debug que pode ou não ser ativado. Este modo debug imprime várias informações sobre toda a execução do programa desenvolvido. Uma transferência só é bem sucedida se todas as respostas por parte do servidor contiverem o código de resposta positivo em relação à mensagem enviada pelo programa.

